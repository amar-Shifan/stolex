<%-include('../partials/header.ejs',{title:"admin page",style:'/css/checkOut.css' })%>

<div class="container checkout-container">
    <form id="checkoutForm">
        <div class="row">
            <!-- Left Side: Addresses -->
            <div class="col-lg-8">
                <div class="saved-addresses">
                    <h3 class="mb-4">Select Shipping Address</h3>

                    <!-- Loop through user's saved addresses -->
                    <% if (user && user.address && user.address.length > 0) { %>
                        <% user.address.forEach((address, index) => { %>
                            <div class="address-card">
                                <input 
                                    type="radio" 
                                    name="shippingAddress" 
                                    id="address<%= index %>" 
                                    value="<%= address._id %>" 
                                    <%= index === 0 ? 'checked' : '' %> 
                                    required
                                >
                                <label for="address<%= index %>">
                                    <strong><%= address.fullName %></strong><br>
                                    <%= address.street %>, <%= address.city %>, <%= address.state %>, <%= address.zip %><br>
                                    Phone: <%= address.phoneNumber %>
                                </label>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p>No saved addresses. Please add one.</p>
                    <% } %>

                    <div class="text-center mt-3">
                        <button class="btn btn-add-address" type="button" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                            + Add New Address
                        </button>
                    </div>
                </div>

                <!-- Payment Methods Section -->
                <div class="payment-methods">
                    <h3 class="mb-4">Select Payment Method</h3>

                    <!-- Razorpay Payment Option -->
                    <div class="payment-method">
                        <input type="radio" name="paymentMethod" id="razorpay" value="razorpay" required>
                        <label for="razorpay">
                            <img src="/images/razorpay.webp" alt="Razorpay">
                            <div>
                                <h5>Razorpay Online Payment</h5>
                                <p class="text-muted">Pay securely using credit/debit cards, net banking, UPI, and wallets</p>
                            </div>
                        </label>
                    </div>

                    <!-- Cash on Delivery Option -->
                    <div class="payment-method">
                        <input type="radio" name="paymentMethod" id="cod" value="cod">
                        <label for="cod">
                            <img src="/images/cashondelivery.jpg" alt="Cash on Delivery">
                            <div>
                                <h5>Cash on Delivery (COD)</h5>
                                <p class="text-muted">Pay in cash when your order is delivered</p>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Right Side: Cart Summary -->
            <div class="col-lg-4">
                <div class="cart-summary">
                    <h3 class="mb-4">Order Summary</h3>

                    <!-- Product Items -->
                    <% if (cart && cart.items.length > 0) { %>
                        <% cart.items.forEach(item => { %>
                            <div class="product-item"> 
                                <img src="<%= item.productId.images[0] %>" alt="<%= item.productId.name %>">
                                <div class="flex-grow-1">
                                    <h5><%= item.productId.name %></h5>
                                    <p>Quantity: <%= item.quantity %> | Size: <%= item.size %></p>
                                    <p class="text-muted">₹<%= item.price.toFixed(2) %> each</p>
                                </div>
                                <div>
                                    <strong>₹<%= item.total.toFixed(2) %></strong>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p>Your cart is empty.</p>
                    <% } %>

                    <!-- Order Total -->
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span>₹<%= cart ? cart.subtotal.toFixed(2) : '0.00' %></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping</span>
                            <span>₹50.00</span>
                        </div>
                        <div class="d-flex justify-content-between font-weight-bold">
                            <strong>Total</strong>
                            <strong>₹<%= cart ? (cart.subtotal + 50).toFixed(2) : '50.00' %></strong>
                        </div>
                    </div>

                    <!-- Coupon Section -->
                    <div class="coupon-section mt-4">
                        <h5>Apply Coupon</h5>
                        <div class="input-group">
                            <input type="text" name="couponCode" class="form-control" placeholder="Enter coupon code">
                            <button class="btn btn-dark" type="button">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Proceed to Payment Button -->
        <div class="text-center mt-5">
            <button type="submit" class="btn btn-primary btn-lg">
                Proceed to Payment
            </button>
        </div>
    </form>
</div>


<!-- Add New Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addAddress">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" name="fullName" placeholder="Enter full name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" rows="3" name="address" placeholder="Enter your address"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" name="city" placeholder="Enter city">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">State</label>
                            <input type="text" class="form-control" name="state" placeholder="Enter state">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">PIN Code</label>
                        <input type="text" class="form-control" name="pincode" placeholder="Enter ZIP code">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control"  name="phoneNumber" placeholder="Enter phone number">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Address</button>
                </div>
            </form>
        </div>
    </div>
</div>



<%- include('../partials/footer.ejs') %>
<script>
    
// adding the user Address

document.getElementById('addAddress').addEventListener('submit' , async(e)=>{
    e.preventDefault();

    const form = e.target 
    const formData = new FormData(form);

    try {
        
        const formObject = Object.fromEntries(formData.entries());

        const response = await fetch('/addAddress' , {
            method : 'post',
            headers : {'Content-Type' : 'application/json'},
            body : JSON.stringify(formObject)
        })

        const data = await response.json();

        if(data.success){
            showNotification('success' , data.message)
            setTimeout(()=>{
                location.reload()
            },2000)
        }else{
            showNotification('error',data.message)
        }


    } catch (error) {
        console.log(error, 'error in adding the user Address')
        showNotification('error',"Something went wrong!")
    }
})
document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
    e.preventDefault(); // Prevent default form submission behavior

    const form = e.target;
    const formData = new FormData(form);

    try {
        const formObject = Object.fromEntries(formData.entries());

        const response = await fetch("/checkout/process", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formObject),
        });

        const data = await response.json();

        if (response.ok && data.success) {
            showNotification('success', data.message);

            setTimeout(() => {
                location.href = '/cart/success';
            }, 2000);
        } else {
            showNotification('error', data.message || 'Failed to process checkout.');
        }
    } catch (error) {
        console.error('Error processing checkout:', error);

        showNotification('error', 'Something went wrong. Please try again later.');
    }
});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>